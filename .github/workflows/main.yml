# V13 修复版: 修正 Release 权限问题
name: 定时运行港股数据抓取

on:
  # 1. 允许手动触发
  workflow_dispatch:

  # 2. 定时触发
  schedule:
    # 语法: 分 时 日 月 周 (UTC 时间)
    # '0 */2 * * *' = 每 2 小时运行一次 (在 00:00, 02:00, 04:00... UTC)
    - cron: '0 * * * *'

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    # --- (V13 修复) ---
    # 授权 Actions 具有写入(write)权限，以便创建 Release
    permissions:
      contents: write
    # --- (修复结束) ---

    steps:
      # 1. 检出代码
      - name: 1. 检出 (Checkout) 代码
        uses: actions/checkout@v4

      # 2. 设置 Python 环境
      - name: 2. 设置 Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # 缓存 pip 依赖

      # 3. 安装 Python 库
      - name: 3. 安装依赖库
        run: |
          pip install -r requirements.txt
          
      # 4. 运行 Python 脚本
      - name: 4. 运行 V12 打分脚本
        run: |
          # A. 生成文件名和 Tag 名
          # 使用 "Asia/Shanghai" 时区，确保日期正确
          TIMESTAMP_SHANGHAI=$(TZ="Asia/Shanghai" date +'%Y-%m-%d_%H-%M-%S')
          TAG_NAME=$(TZ="Asia/Shanghai" date +'%Y-%m-%d-%H%M')
          
          FILE_NAME="${TIMESTAMP_SHANGHAI}.xlsx"
          
          # B. 将变量导出到 GitHub 环境
          echo "FILE_NAME=${FILE_NAME}" >> $GITHUB_ENV
          echo "TAG_NAME=report-${TAG_NAME}" >> $GITHUB_ENV

          # C. 运行脚本，使用新文件名
          python yf251110.py "${FILE_NAME}"
          
      # 5. 创建 Release 并上传附件
      # (V13 修复: 切换到更稳定的 softprops/action-gh-release)
      - name: 5. 创建 Release 并上传附件
        uses: softprops/action-gh-release@v1
        with:
          # 使用 GITHUB_TOKEN
          token: ${{ secrets.GITHUB_TOKEN }}
          # 要上传的文件
          files: ./${{ env.FILE_NAME }}
          # Git 标签名
          tag_name: ${{ env.TAG_NAME }}
          # Release 的标题
          name: 港股数据报告 ${{ env.TAG_NAME }}
          # Release 的描述
          body: "这是由 GitHub Actions 自动生成的最新港股数据报告。"
          # 设置为非草稿、非预发布
          draft: false
          prerelease: false

# -----------------------------------------------------------------
# GitHub Actions 配置文件
#
# 必须将此文件放置在您代码库的 .github/workflows/ 文件夹下
# 路径: .github/workflows/main.yml
# (V12.1 - 更新：发布到 Release 页面)
# -----------------------------------------------------------------

name: '定时运行港股数据抓取'

on:
  # 1. 允许您在 GitHub 网站的 "Actions" 页面手动点击 "Run workflow" 来运行
  workflow_dispatch:
  
  # 2. 定时触发
  schedule:
    # 语法: 分 时 日 月 周 (UTC 时间)

    - cron: '0 */2 * * *'

jobs:
  run-yfinance-fetcher:
    # 使用最新的 Ubuntu 服务器环境
    runs-on: ubuntu-latest
    
    # 定义任务步骤
    steps:
      # 第一步: 检出 (Checkout) 你的代码
      - name: '检出代码'
        uses: actions/checkout@v4

      # 第二步: 设置 Python 3.10 环境
      - name: '设置 Python 3.10'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # 缓存依赖项，加快后续运行速度

      # 第三步: 安装 Python 依赖
      - name: '安装依赖'
        run: pip install -r requirements.txt

      # 第四步: 运行你的 Python 脚本 (V12.1: 修正为 V12 脚本)
      - name: '运行 yfinance 抓取脚本 (V12)'
        run: python yf251110.py

      # 第五步: 准备发布所需变量
      # (a) 生成一个唯一的标签名, 例如 report-2025-11-10-08-00-00
      # (b) 获取 Python 脚本生成的 .xlsx 文件名
      - name: '准备发布所需变量'
        id: vars
        run: |
          echo "tag=report-$(date +'%Y-%m-%d-%H-%M-%S')" >> $GITHUB_OUTPUT
          echo "filename=$(ls ./*.xlsx)" >> $GITHUB_OUTPUT

      # 第六步: 创建 Release 并上传 Excel 文件 (替换原有的 upload-artifact)
      # https://github.com/svenstaro/upload-release-action
      - name: '创建 Release 并上传报告'
        uses: svenstaro/upload-release-action@v2
        with:
          # 仓库令牌，用于授权
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          
          # 要上传的文件 (从上一步获取)
          file: ${{ steps.vars.outputs.filename }}
          
          # Git 标签名 (例如: report-2025-11-10-08-00-00)
          tag: ${{ steps.vars.outputs.tag }}
          
          # Release 的标题
          release_name: '港股数据报告 ${{ steps.vars.outputs.tag }}'
          
          # Release 的描述
          body: '这是由 GitHub Actions 自动生成的最新港股数据报告。'
          
          # 允许覆盖已有的同名标签 (以防万一)
          overwrite: true 
          
          # 这不是一个草稿
          draft: false
          
          # 这不是一个预发布版
          prerelease: false
